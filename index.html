<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบังชีรายรับรายจ่าย</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input, select {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>ระบบบังชีรายรับรายจ่าย</h1>

    <form id="form">
        <label for="type">ประเภท:</label>
        <select id="type" required>
            <option value="รายรับ">รายรับ</option>
            <option value="รายจ่าย">รายจ่าย</option>
        </select><br>

        <label for="category">หมวดหมู่:</label>
        <input type="text" id="category" placeholder="เช่น ค่าอาหาร" required><br>

        <label for="amount">จำนวนเงิน:</label>
        <input type="number" id="amount" placeholder="จำนวนเงิน" required><br>

        <label for="description">รายละเอียด:</label>
        <input type="text" id="description" placeholder="เช่น รายได้จากงาน" required><br>

        <button type="submit">เพิ่มรายการ</button>
    </form>

    <h2>รายการบัญชี</h2>
    <table id="transactions-table">
        <thead>
            <tr>
                <th>ประเภท</th>
                <th>หมวดหมู่</th>
                <th>รายละเอียด</th>
                <th>จำนวนเงิน</th>
                <th>วันที่</th>
            </tr>
        </thead>
        <tbody>
            <!-- รายการจะเพิ่มที่นี้ -->
        </tbody>
    </table>

    <!-- ปุ่มสำหรับการจัดการข้อมูล -->
    <div style="margin-top: 20px;">
        <button id="exportButton" type="button">ดาวน์โหลดข้อมูล</button>
        <button id="importButton" type="button">นำเข้าข้อมูล</button>
        <button id="clearButton" type="button">ล้างข้อมูลทั้งหมด</button>
        <!-- อินพุตไฟล์ถี่ถู่ซ่อนไว้ ใช้สำหรับนำเข้าข้อมูล -->
        <input type="file" id="fileInput" accept="application/json" style="display: none;">
    </div>

    <script>
        /*
         * ระบบบังชีรายรับรายจ่ายเวอร์ชันปรับปรุงนี้จะเก็บข้อมูลรายการใน localStorage
         * เพื่อให้ข้อมูลคงอยู่แม้หลังจากปิดหรือรีเฟรชหน้าเว็บ ทั้งนี้ localStorage
         * เป็นตัวเก็บข้อมูลฝั่งไคลเอนต์ที่ไม่มีวันหมดอายุ ( ต่างจาก sessionStorage )
         * ตามที่เอกสาร MDN อธิบายไว้ว่า "stored data is saved across browser sessions"【349012388019771†L185-L193】
         */
        const form = document.getElementById("form");
        const transactionsTableBody = document.getElementById("transactions-table").getElementsByTagName('tbody')[0];

        // โหลดรายการจาก localStorage หากมี
        let transactions = [];
        const saved = localStorage.getItem('transactions');
        if (saved) {
            try {
                transactions = JSON.parse(saved);
            } catch (e) {
                console.error('ไม่สามารถ์แปลงข้อมูลที่เก็บไว้:', e);
                transactions = [];
            }
        }

        // ฟังก์ชันสำหรับบันทึก localStorage
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        // แสดงรายการทั้งหมดในตาราง
        function renderTransactions() {
            // เคลียร์ข้อมูลเก่าก่อนแสดงใหม่
            transactionsTableBody.innerHTML = '';
            transactions.forEach(item => {
                const row = transactionsTableBody.insertRow();
                row.insertCell(0).innerText = item.type;
                row.insertCell(1).innerText = item.category;
                row.insertCell(2).innerText = item.description;
                row.insertCell(3).innerText = item.amount;
                row.insertCell(4).innerText = item.date;
            });
        }

        // เรียกฟังก์ชันเพื่อแสดงข้อมูลเมื่อโหลดหน้าเว็บ
        renderTransactions();

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const type = document.getElementById("type").value;
            const category = document.getElementById("category").value;
            const amount = document.getElementById("amount").value;
            const description = document.getElementById("description").value;
            const date = new Date().toLocaleDateString();

            // เพิ่มลงในรายการ
            const transaction = { type, category, description, amount, date };
            transactions.push(transaction);
            saveTransactions();

            // เพิ่มแทวใหม่ในตาราง
            const newRow = transactionsTableBody.insertRow();
            newRow.insertCell(0).innerText = type;
            newRow.insertCell(1).innerText = category;
            newRow.insertCell(2).innerText = description;
            newRow.insertCell(3).innerText = amount;
            newRow.insertCell(4).innerText = date;

            // รีเซ็ตฟอร์ม
            form.reset();
        });

        // ฟังก์ชันดาวน์โหลดข้อมูลทั้งหมดเป็นไฟล์ JSON
        document.getElementById('exportButton').addEventListener('click', function() {
            const dataStr = JSON.stringify(transactions);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'transactions.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        // เมื่อคลิกปุ่มนำเข้าจะเรียกเลือกไฟล์
        document.getElementById('importButton').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        // อ่านไฟล์ JSON และอัพเดตข้อมูล
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (Array.isArray(imported)) {
                        transactions = imported;
                        saveTransactions();
                        renderTransactions();
                    } else {
                        alert('รูปแบบข้อมูลไม่ถู่ก้อง');
                    }
                } catch (err) {
                    alert('ไม่สามารถ์อ่านไฟล์ JSON ได้');
                }
            };
            reader.readAsText(file);
            // รีเซ็ตค่าไฟล์อินพุตเพื่อให้สามารถ์นำเข้าไฟล์เดิมซ้ำได้
            e.target.value = '';
        });

        // ฟังก์ชันลบข้อมูลทั้งหมด
        document.getElementById('clearButton').addEventListener('click', function() {
            if (confirm('คุณต้องการลบข้อมูลทั้งหมดหรือไม?')) {
                transactions = [];
                saveTransactions();
                renderTransactions();
            }
        });
    </script>
</body>
</html>
